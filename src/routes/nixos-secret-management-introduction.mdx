---
date: 2024-09-29T19:13:48.385245919+08:00
description: Most NixOS Secret Management Tools In Common
categories:
  - 简介
tags:
  - security
  - NixOS
  - sops-nix
  - agenix
  - agenix-rekey
  - vaultix
draft: true
title: NixOS 密钥管理导论
---

# Overview
在 NixOS（下称nix）储存凭据有一个比较独特的问题，主要由几个nix的特点产生：

+ nix 的系统配置在重新构建(rebuild) 的时候，为了确保其纯净性(purity)，所有nix file中引用的path 都必须[<sup>1</sup>](#refer-1)在 nix store 中。

本文以
+ sops-nix
+ agenix
+ agenix-rekey
+ vaultix

为例，总结一些nix上密钥管理软件的规律。

# Anti Pattern

这么说是因为这种密钥管理需要有一个per host的identity用来给设备解密（设备端存有私钥），以及一个独立的identity给用户加密然后存在store里。在sopsnix里面前者是通过 ssh-keyscan 然后可选convert后放在[这里](https://github.com/Mic92/sops-nix/blob/127a96f49ddc377be6ba76964411bab11ae27803/README.md?plain=1#L249) ，无论是gpg还是age都是从per server的host public key [derive](https://github.com/Mic92/sops-nix/blob/127a96f49ddc377be6ba76964411bab11ae27803/README.md?plain=1#L222)出来的。后者用户自己[生成](https://github.com/Mic92/sops-nix/blob/127a96f49ddc377be6ba76964411bab11ae27803/README.md?plain=1#L118) 然后放在[这里](https://github.com/Mic92/sops-nix/blob/127a96f49ddc377be6ba76964411bab11ae27803/README.md?plain=1#L248) 。可以只在用来部署的机器上存在

# 注脚

<div id="refer-1"/>
- [1] 可以额外添加 `--impure` 来继续构建。
